<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Image from Webcam</title>
    <script src="https://cdn.tailwindcss.com"></script> <!-- Tailwind CSS CDN -->
    <script>
        let videoStream;

        function startWebcam() {
            const video = document.getElementById("webcam");
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.play();
                })
                .catch(err => {
                    console.error("Error accessing webcam: " + err);
                });
        }

        function captureImage() {
            const video = document.getElementById("webcam");
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL("image/png");  // Convert to a data URL (base64)
        }

        function stopWebcam() {
            if (videoStream) {
                let tracks = videoStream.getTracks();
                tracks.forEach(track => track.stop());
            }
        }

        function uploadCapturedImage(event) {
            event.preventDefault();
            const imageData = captureImage();
            const formData = new FormData();
            formData.append("file", dataURItoBlob(imageData), "webcam_image.png");

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/upload", true);
            xhr.onload = function () {
                const response = JSON.parse(xhr.responseText);
                if (xhr.status === 200) {
                    document.getElementById("message").style.display = "block";
                    document.getElementById("message").textContent = "檢測結果: " + response.predictions;
                    document.getElementById("uploadedImage").style.display = "block";
                    document.getElementById("uploadedImage").src = "./static/uploads/webcam_image.png?rand=" + Math.random();
                    console.log(response);
                } else {
                    document.getElementById("message").textContent = response.error;
                }
            };
            xhr.send(formData);
        }

        function dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(",")[1]);
            const mimeString = dataURI.split(",")[0].split(":")[1].split(";")[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }
    </script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
    <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-lg">
        <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">中藥材檢測出入記錄資料庫</h1>

        <div class="flex justify-center mb-4">
            <video id="webcam" class="rounded-lg border border-gray-300 shadow-sm" width="300" height="200"
                autoplay></video>
        </div>

        <div class="text-center">
            <button onclick="uploadCapturedImage(event)"
                class="top-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow">
                檢測
            </button>
        </div>

        <p id="message" class="hidden text-center text-green-500 font-semibold mt-4"></p>

        <div class="mt-6 text-center">
            <img alt="captureImage" id="uploadedImage"
                class="hidden mx-auto rounded-lg border border-gray-300 shadow-sm" width="300" />
        </div>
    </div>

    <script>
        window.onload = startWebcam;
    </script>
</body>

</html>